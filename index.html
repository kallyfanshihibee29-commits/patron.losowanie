<!doctype html>
<html lang="pl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patron Tygodnia</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&amp;family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(180deg, #9fc6e2 0%, #cfe8f8 100%);
      color: #1e3a8a;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      padding-top: 40px;
      transition: background 0.5s ease, color 0.5s ease;
    }

    .app-wrapper {
      width: 100%;
      max-width: 440px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .app-title {
      font-family: 'Pacifico', cursive;
      font-size: 42px;
      color: #1e3a8a;
      margin-bottom: 24px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(6, 21, 52, 0.15);
      transition: color 0.5s ease;
    }

    .app-container {
      width: 100%;
      background: white;
      border-radius: 16px;
      padding: 35px 30px;
      box-shadow: 
        0 8px 24px rgba(6, 21, 52, 0.12),
        0 16px 48px rgba(59, 89, 152, 0.12);
    }

    .patron-display {
      background: linear-gradient(135deg, #3b5998 0%, #5a8dee 100%);
      border-radius: 12px;
      padding: 32px 24px;
      margin-bottom: 24px;
      box-shadow: 
        0 4px 12px rgba(6, 21, 52, 0.1),
        0 8px 24px rgba(59, 89, 152, 0.1);
      min-height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: background 0.5s ease;
    }

    .patron-content {
      width: 100%;
      text-align: center;
    }

    .patron-name {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: white;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .patron-prayer {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      font-size: 15px;
      color: rgba(255, 255, 255, 0.95);
      line-height: 1.5;
    }

    .placeholder-text {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
    }

    .draw-button-container {
      text-align: center;
      margin-bottom: 24px;
    }

    .draw-button {
      background: linear-gradient(135deg, #3b5998 0%, #5a8dee 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 50px;
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 
        0 4px 12px rgba(6, 21, 52, 0.12),
        0 6px 20px rgba(59, 89, 152, 0.12);
      transition: all 0.3s ease;
    }

    .draw-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 
        0 6px 16px rgba(6, 21, 52, 0.16),
        0 8px 28px rgba(59, 89, 152, 0.16);
    }

    .draw-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .draw-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .countdown-container {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e9ecef;
    }

    .countdown-label {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      font-size: 14px;
      color: #1e3a8a;
      margin-bottom: 10px;
      opacity: 0.85;
      transition: color 0.5s ease;
    }

    .countdown-timer {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: #2b7bd6;
      letter-spacing: 0.5px;
      transition: color 0.5s ease;
    }

    .history-button-container {
      text-align: center;
      margin-top: 20px;
    }

    .history-button {
      background: white;
      color: #3b5998;
      border: 2px solid #3b5998;
      border-radius: 12px;
      padding: 14px 40px;
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .history-button:hover {
      background: white;
      color: #3b5998;
      border-color: #3b5998;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 89, 152, 0.2);
    }

    .settings-button {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 500;
      border: none;
      font-size: 22px;
    }

    .settings-button:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: scale(1.15);
    }

    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease;
    }

    .settings-modal-content {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      width: 100%;
      max-width: 500px;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 8px 32px rgba(31, 38, 135, 0.15),
        inset 0 0 20px rgba(255, 255, 255, 0.3);
      animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes popIn {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    }

    .settings-title {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: #1e3a8a;
      margin: 0;
      text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5);
      transition: color 0.5s ease;
    }

    .settings-content {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
    }

    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      position: relative;
    }

    .tab-indicator {
      position: absolute;
      bottom: -2px;
      height: 3px;
      background: #3b5998;
      transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
      border-radius: 3px 3px 0 0;
      z-index: 1;
    }

    .settings-tab {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 8px 8px 0 0;
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 14px;
      color: #1e3a8a;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
    }

    .settings-tab:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .settings-tab.active {
      background: rgba(255, 255, 255, 0.5);
    }

    .settings-tab-content {
      display: none;
      animation: fadeSlideIn 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .settings-tab-content.active {
      display: block;
    }

    @keyframes fadeSlideIn {
      0% {
        opacity: 0;
        transform: translateX(-30px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .settings-section-title {
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 16px;
      color: #1e3a8a;
      margin-bottom: 16px;
      transition: color 0.5s ease;
    }

    #allHistoryList,
    #favoritesHistoryList {
      max-height: 400px;
      overflow-y: auto;
    }

    .color-themes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .color-theme-card {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 12px;
      padding: 14px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 0;
      opacity: 0;
      transform: scale(0.5) translateY(20px);
      animation: cardPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .color-theme-card:nth-child(1) { animation-delay: 0.05s; }
    .color-theme-card:nth-child(2) { animation-delay: 0.1s; }
    .color-theme-card:nth-child(3) { animation-delay: 0.15s; }
    .color-theme-card:nth-child(4) { animation-delay: 0.2s; }
    .color-theme-card:nth-child(5) { animation-delay: 0.25s; }
    .color-theme-card:nth-child(6) { animation-delay: 0.3s; }
    .color-theme-card:nth-child(7) { animation-delay: 0.35s; }
    .color-theme-card:nth-child(8) { animation-delay: 0.4s; }
    .color-theme-card:nth-child(9) { animation-delay: 0.45s; }
    .color-theme-card:nth-child(10) { animation-delay: 0.5s; }
    .color-theme-card:nth-child(11) { animation-delay: 0.55s; }
    .color-theme-card:nth-child(12) { animation-delay: 0.6s; }
    .color-theme-card:nth-child(13) { animation-delay: 0.65s; }
    .color-theme-card:nth-child(14) { animation-delay: 0.7s; }
    .color-theme-card:nth-child(15) { animation-delay: 0.75s; }
    .color-theme-card:nth-child(16) { animation-delay: 0.8s; }
    .color-theme-card:nth-child(17) { animation-delay: 0.85s; }
    .color-theme-card:nth-child(18) { animation-delay: 0.9s; }

    @keyframes cardPopIn {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(20px) rotate(-5deg);
      }
      70% {
        transform: scale(1.05) translateY(-5px) rotate(2deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0) rotate(0deg);
      }
    }

    .color-theme-card:hover {
      border-color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px) scale(1.05);
    }

    .color-theme-card.active {
      border-color: #3b5998;
      border-width: 3px;
      background: rgba(255, 255, 255, 0.6);
    }

    .color-theme-name {
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 11px;
      color: #1e3a8a;
      transition: color 0.5s ease;
      text-align: center;
      line-height: 1.2;
    }

    .color-theme-subtitle {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      font-size: 9px;
      color: #666;
      text-align: center;
      margin-top: 2px;
      opacity: 0.8;
    }

    .color-preview {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .confirm-delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .confirm-delete-content {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: 
        0 8px 32px rgba(31, 38, 135, 0.15),
        inset 0 0 20px rgba(255, 255, 255, 0.3);
      text-align: center;
    }

    .confirm-delete-title {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 20px;
      color: #1e3a8a;
      margin-bottom: 16px;
      transition: color 0.5s ease;
    }

    .confirm-delete-message {
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      color: #333;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .confirm-delete-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .confirm-delete-btn {
      padding: 12px 32px;
      border-radius: 8px;
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .confirm-delete-yes {
      background: #dc3545;
      color: white;
    }

    .confirm-delete-yes:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .confirm-delete-no {
      background: white;
      color: #333;
      border: 2px solid #ddd;
    }

    .confirm-delete-no:hover {
      background: #f8f9fa;
      border-color: #999;
      transform: translateY(-2px);
    }

    .history-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .history-modal-content {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      width: 100%;
      max-width: 500px;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 8px 32px rgba(31, 38, 135, 0.15),
        inset 0 0 20px rgba(255, 255, 255, 0.3);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    }

    .history-title {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: #1e3a8a;
      margin: 0;
      text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5);
      transition: color 0.5s ease;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 28px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .close-button:hover {
      background: #f0f0f0;
      color: #333;
    }

    .history-list {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .no-history-text {
      text-align: center;
      color: #666;
      padding: 40px 20px;
      font-size: 16px;
    }

    .history-item {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.2s ease;
      opacity: 0;
      transform: scale(0.8) translateY(20px);
      animation: patronPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .history-item:nth-child(1) { animation-delay: 0.05s; }
    .history-item:nth-child(2) { animation-delay: 0.1s; }
    .history-item:nth-child(3) { animation-delay: 0.15s; }
    .history-item:nth-child(4) { animation-delay: 0.2s; }
    .history-item:nth-child(5) { animation-delay: 0.25s; }
    .history-item:nth-child(6) { animation-delay: 0.3s; }
    .history-item:nth-child(7) { animation-delay: 0.35s; }
    .history-item:nth-child(8) { animation-delay: 0.4s; }
    .history-item:nth-child(9) { animation-delay: 0.45s; }
    .history-item:nth-child(10) { animation-delay: 0.5s; }

    @keyframes patronPopIn {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(20px) rotate(-3deg);
      }
      70% {
        transform: scale(1.03) translateY(-5px) rotate(1deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0) rotate(0deg);
      }
    }

    .history-item:hover {
      border-color: rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.5);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .history-item-name {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: 18px;
      color: #1e3a8a;
      flex: 1;
      margin-right: 12px;
      transition: color 0.5s ease;
    }

    .history-item-actions {
      display: flex;
      gap: 8px;
    }

    .star-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
      transition: transform 0.2s ease;
      line-height: 1;
    }

    .star-button:hover {
      transform: scale(1.2);
    }

    .star-button.favorited {
      animation: starPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .star-button.filled {
      transition: color 0.5s ease;
    }

    @keyframes starPop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.4) rotate(15deg);
      }
      100% {
        transform: scale(1);
      }
    }

    .delete-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      transition: all 0.2s ease;
      border-radius: 6px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-button:hover {
      background: #dc3545;
      transform: scale(1.1);
    }

    .delete-button:hover svg {
      fill: white;
    }

    .delete-icon {
      width: 18px;
      height: 18px;
      fill: #dc3545;
      transition: fill 0.2s ease;
    }

    .history-item-prayer {
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      color: #555;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .history-item-date {
      font-family: 'Roboto', sans-serif;
      font-size: 12px;
      color: #999;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    /* Animacja przelatujƒÖcych patron√≥w */
    .patron-display.slot-machine .patron-content {
      animation: slotRoll 0.08s linear infinite;
    }

    @keyframes slotRoll {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      50% {
        transform: translateY(-10px);
        opacity: 0.7;
      }
      100% {
        transform: translateY(10px);
        opacity: 1;
      }
    }

    .patron-display.final-reveal .patron-content {
      animation: revealPatron 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes revealPatron {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      .app-wrapper {
        max-width: 100%;
      }

      .app-title {
        font-size: 36px;
        margin-bottom: 20px;
      }

      .app-container {
        padding: 28px 22px;
      }

      .patron-display {
        padding: 28px 20px;
        min-height: 160px;
        margin-bottom: 20px;
      }

      .patron-name {
        font-size: 22px;
        margin-bottom: 10px;
      }

      .patron-prayer {
        font-size: 14px;
      }

      .placeholder-text {
        font-size: 15px;
      }

      .draw-button-container {
        margin-bottom: 20px;
      }

      .draw-button {
        padding: 15px 45px;
        font-size: 17px;
      }

      .countdown-container {
        padding: 18px;
      }

      .countdown-label {
        font-size: 13px;
        margin-bottom: 8px;
      }

      .countdown-timer {
        font-size: 22px;
      }

      .settings-button {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .color-themes-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><button class="settings-button" id="settingsButton">‚öôÔ∏è</button>
  <div class="app-wrapper">
   <h1 class="app-title" id="mainTitle">Patron Tygodnia</h1>
   <div class="app-container">
    <div class="patron-display" id="patronDisplay">
     <div class="patron-content" id="patronContent">
      <p class="placeholder-text">Wylosuj swojego patrona na ten tydzie≈Ñ</p>
     </div>
     <div id="loadingSpinner" class="loading-spinner hidden"></div>
    </div>
    <div class="draw-button-container"><button class="draw-button" id="drawButton">Losuj</button>
    </div>
    <div class="countdown-container" id="countdownContainer" style="display: none;">
     <div class="countdown-label" id="countdownLabel">
      Nastƒôpne losowanie za:
     </div>
     <div class="countdown-timer" id="countdownTimer">
      -
     </div>
    </div>
    <div class="history-button-container"><button class="history-button" id="historyButton">Historia Patron√≥w</button>
    </div>
   </div>
   <div class="settings-modal hidden" id="settingsModal">
    <div class="settings-modal-content">
     <div class="settings-header">
      <h2 class="settings-title">Ustawienia</h2><button class="close-button" id="closeSettingsButton">‚úï</button>
     </div>
     <div class="settings-content">
      <div class="settings-tabs" id="settingsTabs">
       <div class="tab-indicator" id="settingsTabIndicator"></div><button class="settings-tab active" data-tab="regular">Kolorowe Tematy</button> <button class="settings-tab" data-tab="seasonal">Kolory Sezonowe</button>
      </div>
      <div class="settings-tab-content active" id="regularTab">
       <div class="settings-section-title">
        Wybierz schemat kolor√≥w
       </div>
       <div class="color-themes-grid" id="colorThemesGrid"></div>
      </div>
      <div class="settings-tab-content" id="seasonalTab">
       <div class="settings-section-title">
        Wybierz motyw sezonowy
       </div>
       <div class="color-themes-grid" id="seasonalThemesGrid"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="history-modal hidden" id="historyModal">
    <div class="history-modal-content">
     <div class="history-header">
      <h2 class="history-title">Historia Patron√≥w</h2><button class="close-button" id="closeHistoryButton">‚úï</button>
     </div>
     <div class="settings-content">
      <div class="settings-tabs" id="historyTabs">
       <div class="tab-indicator" id="historyTabIndicator"></div><button class="settings-tab active" data-tab="recent">Ostatnie Losowanie</button> <button class="settings-tab" data-tab="allhistory">Ca≈Ça Historia</button> <button class="settings-tab" data-tab="favorites">Oznaczeni GwiazdkƒÖ</button>
      </div>
      <div class="settings-tab-content active" id="recentTab">
       <div class="history-list" id="historyList">
        <p class="no-history-text">Brak historii losowa≈Ñ</p>
       </div>
      </div>
      <div class="settings-tab-content" id="allHistoryTab">
       <div id="allHistoryList"></div>
      </div>
      <div class="settings-tab-content" id="favoritesTab">
       <div id="favoritesHistoryList"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="confirm-delete-modal hidden" id="confirmDeleteModal">
    <div class="confirm-delete-content">
     <h3 class="confirm-delete-title">Potwierd≈∫ usuniƒôcie</h3>
     <p class="confirm-delete-message">Czy na pewno chcesz usunƒÖƒá tego patrona z historii?</p>
     <div class="confirm-delete-buttons"><button class="confirm-delete-btn confirm-delete-no" id="cancelDeleteBtn">Anuluj</button> <button class="confirm-delete-btn confirm-delete-yes" id="confirmDeleteBtn">Usu≈Ñ</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "Patron Tygodnia",
      draw_button_text: "Losuj",
      time_remaining_label: "Nastƒôpne losowanie za:",
      history_button_text: "Historia Patron√≥w",
      background_color: "#9fc6e2",
      background_color_end: "#cfe8f8",
      primary_color: "#3b5998",
      primary_color_end: "#5a8dee",
      accent_color: "#2b7bd6",
      navy_color: "#1e3a8a",
      modal_background: "#ffffff",
      font_family: "Roboto",
      font_size: 16,
      color_theme: "blue",
      is_seasonal: false
    };

    const seasonalThemes = {
      christmas: {
        name: "≈öwiƒÖteczna Harmonia üéÑ",
        subtitle: "Do 1 Stycznia",
        bg: "#1a472a",
        bgEnd: "#2d5a3d",
        text: "#c41e3a",
        gradientStart: "#c41e3a",
        gradientEnd: "#8b0000",
        accent: "#c41e3a",
        textShadow: "none",
        titleColor: "#ffffff",
        titleShadow: "0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6)",
        isSeasonal: true
      },
      snow: {
        name: "≈önie≈ºna Zadyma ‚ùÑÔ∏è",
        subtitle: "Do 2 Lutego",
        bg: "#e0f2fe",
        bgEnd: "#f0f9ff",
        text: "#0c4a6e",
        gradientStart: "#0ea5e9",
        gradientEnd: "#38bdf8",
        accent: "#0284c7",
        textShadow: "none"
      }
    };

    const colorThemes = {
      rose: {
        name: "Jasny r√≥≈ºany",
        bg: "#ffe4e6",
        bgEnd: "#fef2f2",
        text: "#881337",
        gradientStart: "#f43f5e",
        gradientEnd: "#e11d48",
        accent: "#dc2626",
        textShadow: "none"
      },
      pink: {
        name: "R√≥≈ºowy",
        bg: "#fce7f3",
        bgEnd: "#fdf2f8",
        text: "#831843",
        gradientStart: "#db2777",
        gradientEnd: "#ec4899",
        accent: "#be185d",
        textShadow: "none"
      },
      pumpkin: {
        name: "Dojrza≈Ça dynia",
        bg: "#ff6b35",
        bgEnd: "#ffedd5",
        text: "#7c2d12",
        gradientStart: "#ea580c",
        gradientEnd: "#dc2626",
        accent: "#c2410c",
        textShadow: "none"
      },
      orange: {
        name: "Pomara≈Ñczowy",
        bg: "#fed7aa",
        bgEnd: "#fef3c7",
        text: "#92400e",
        gradientStart: "#f59e0b",
        gradientEnd: "#f97316",
        accent: "#d97706",
        textShadow: "none"
      },
      yellow: {
        name: "≈ª√≥≈Çty",
        bg: "#fef08a",
        bgEnd: "#fef9c3",
        text: "#713f12",
        gradientStart: "#eab308",
        gradientEnd: "#facc15",
        accent: "#ca8a04",
        textShadow: "none"
      },
      mustard: {
        name: "Musztardowy",
        bg: "#d4a574",
        bgEnd: "#e8c9a1",
        text: "#5a3e1b",
        gradientStart: "#b8860b",
        gradientEnd: "#daa520",
        accent: "#996515",
        textShadow: "none"
      },
      beige: {
        name: "Be≈ºowy",
        bg: "#f7f3e9",
        bgEnd: "#fdf9f1",
        text: "#8b4513",
        gradientStart: "#e6d7c3",
        gradientEnd: "#d4b896",
        accent: "#c19a6b",
        textShadow: "none"
      },
      latte: {
        name: "Spienione latte",
        bg: "#d4b896",
        bgEnd: "#e8d5b7",
        text: "#5d4037",
        gradientStart: "#8d6e63",
        gradientEnd: "#6d4c41",
        accent: "#795548",
        textShadow: "none"
      },
      olive: {
        name: "Sple≈õnia≈Ça ziele≈Ñ",
        bg: "#8b9467",
        bgEnd: "#a8b584",
        text: "#3d4a2b",
        gradientStart: "#6b7c4f",
        gradientEnd: "#5a6b42",
        accent: "#4a5635",
        textShadow: "none"
      },
      green: {
        name: "Zielony",
        bg: "#a7f3d0",
        bgEnd: "#d1fae5",
        text: "#064e3b",
        gradientStart: "#059669",
        gradientEnd: "#10b981",
        accent: "#047857",
        textShadow: "none"
      },
      turquoise: {
        name: "Jasny turkusowy",
        bg: "#a5f3fc",
        bgEnd: "#cffafe",
        text: "#164e63",
        gradientStart: "#06b6d4",
        gradientEnd: "#0891b2",
        accent: "#0e7490",
        textShadow: "none"
      },
      lightBlue: {
        name: "Jasny b≈Çƒôkit",
        bg: "#bfdbfe",
        bgEnd: "#dbeafe",
        text: "#1e40af",
        gradientStart: "#60a5fa",
        gradientEnd: "#3b82f6",
        accent: "#2563eb",
        textShadow: "none"
      },
      blue: {
        name: "Niebieski",
        bg: "#9fc6e2",
        bgEnd: "#cfe8f8",
        text: "#1e3a8a",
        gradientStart: "#3b5998",
        gradientEnd: "#5a8dee",
        accent: "#2b7bd6",
        textShadow: "none"
      },
      navy: {
        name: "Granatowy",
        bg: "#93c5fd",
        bgEnd: "#bfdbfe",
        text: "#1e3a8a",
        gradientStart: "#1e40af",
        gradientEnd: "#1e3a8a",
        accent: "#1d4ed8",
        textShadow: "none"
      },
      purple: {
        name: "Fioletowy",
        bg: "#e9d5ff",
        bgEnd: "#f3e8ff",
        text: "#581c87",
        gradientStart: "#8b5cf6",
        gradientEnd: "#a855f7",
        accent: "#7c3aed",
        textShadow: "none"
      },
      plum: {
        name: "≈öliwkowy",
        bg: "#c8b5d1",
        bgEnd: "#e6d9ea",
        text: "#4a2c5a",
        gradientStart: "#8e4a9c",
        gradientEnd: "#6b3775",
        accent: "#7a4285",
        textShadow: "none"
      },
      gray: {
        name: "Szary",
        bg: "#e5e7eb",
        bgEnd: "#f3f4f6",
        text: "#111827",
        gradientStart: "#4b5563",
        gradientEnd: "#6b7280",
        accent: "#374151",
        textShadow: "none"
      },
      blackWhite: {
        name: "Czarno-bia≈Çy",
        bg: "#ffffff",
        bgEnd: "#f8f9fa",
        text: "#000000",
        gradientStart: "#000000",
        gradientEnd: "#333333",
        accent: "#666666",
        textShadow: "none"
      }
    };

    const saints = [
      { name: "≈öw. Jan Pawe≈Ç II", prayer: "m√≥dl siƒô nade mnƒÖ o mƒÖdro≈õƒá i dobre wybory." },
      { name: "≈öw. Franciszek z Asy≈ºu", prayer: "czuwaj nade mnƒÖ, bym mia≈Ç(a) w sercu pok√≥j." },
      { name: "≈öw. Antoni z Padwy", prayer: "prowad≈∫ mnie, gdy czego≈õ szukam." },
      { name: "≈öw. Ojciec Pio", prayer: "m√≥dl siƒô o wewnƒôtrznƒÖ si≈Çƒô dla mnie." },
      { name: "≈öw. Matka Teresa z Kalkuty", prayer: "czuwaj, abym nie traci≈Ç(a) wra≈ºliwo≈õci." },
      { name: "≈öw. J√≥zef", prayer: "m√≥dl siƒô o stabilno≈õƒá i bezpiecze≈Ñstwo w moim ≈ºyciu." },
      { name: "≈öw. Rita z Cascii", prayer: "wspieraj mnie w trudnych momentach." },
      { name: "≈öw. Faustyna", prayer: "m√≥dl siƒô o pokÔøΩÔøΩj w moim sercu." },
      { name: "≈öw. Maksymilian Kolbe", prayer: "czuwaj nade mnƒÖ, gdy potrzebujƒô odwagi." },
      { name: "≈öw. Katarzyna ze Sieny", prayer: "m√≥dl siƒô o jasno≈õƒá my≈õli dla mnie." },
      { name: "≈öw. Benedykt", prayer: "prowad≈∫ mnie ku uporzÔøΩÔøΩÔøΩdkowaniu spraw." },
      { name: "≈öw. Klara", prayer: "m√≥dl siƒô o prostotƒô i r√≥wnowagƒô w moim ≈ºyciu." },
      { name: "≈öw. Andrzej Bobola", prayer: "czuwaj nade mnƒÖ, abym potrafi≈Ç(a) budowaƒá zgodƒô." },
      { name: "≈öw. Krzysztof", prayer: "m√≥dl siƒô o bezpiecze≈Ñstwo na moich drogach." },
      { name: "≈öw. Cecylia", prayer: "otaczaj mnie harmoniƒÖ i spokojem." },
      { name: "≈öw. ≈Åukasz", prayer: "m√≥dl siƒô o zdrowie i si≈Çƒô do codzienno≈õci." },
      { name: "≈öw. Piotr Aposto≈Ç", prayer: "czuwaj i umacniaj mnie w wierze." },
      { name: "≈öw. Pawe≈Ç", prayer: "m√≥dl siƒô, abym mia≈Ç(a) serce otwarte." },
      { name: "≈öw. Tomasz Aposto≈Ç", prayer: "prowad≈∫ mnie w chwilach wƒÖtpliwo≈õci." },
      { name: "≈öw. Micha≈Ç Archanio≈Ç", prayer: "czuwaj nade mnƒÖ i chro≈Ñ mnie." },
      { name: "≈öw. Gabriel Archanio≈Ç", prayer: "m√≥dl siƒô o dobre wiadomo≈õci dla mnie." },
      { name: "≈öw. Rafa≈Ç Archanio≈Ç", prayer: "prowad≈∫ mnie ku r√≥wnowadze i spokojowi." },
      { name: "≈öw. Patryk", prayer: "m√≥dl siƒô o odwagƒô w zmianach." },
      { name: "≈öw. MikoÔøΩÔøΩÔøΩÔøΩaj", prayer: "czuwaj nade mnƒÖ i obudzaj dobro w moim ≈ºyciu." },
      { name: "≈öw. Teresa z Lisieux", prayer: "m√≥dl siƒô o ufno≈õƒá i lekkie serce." },
      { name: "≈öw. Teresa z √Åvili", prayer: "wspieraj mnie, gdy mam du≈ºo na g≈Çowie." },
      { name: "≈öw. Marcin z Tours", prayer: "prowad≈∫ mnie do czynienia dobra." },
      { name: "≈öw. Florian", prayer: "m√≥dl siƒô o ochronƒô i spok√≥j wok√≥≈Ç mnie." },
      { name: "≈öw. Hildegarda", prayer: "czuwaj nade mnƒÖ, abym podejmowa≈Ç(a) mƒÖdre decyzje." },
      { name: "≈öw. Carlo Acutis", prayer: "m√≥dl siƒô o r√≥wnowagƒô i dobre korzystanie z tego, co mnie otacza." }
    ];

    let currentPatron = null;
    let countdownInterval = null;
    let isAnimating = false;
    let allPatrons = [];

    const dataHandler = {
      onDataChanged(data) {
        allPatrons = data;
        
        const hadActivePatron = currentPatron !== null;
        const now = Date.now();
        
        if (data.length > 0) {
          const latestDraw = data[data.length - 1];
          
          if (now < latestDraw.expires_timestamp) {
            if (!hadActivePatron || 
                currentPatron.name !== latestDraw.patron_name || 
                currentPatron.expiresAt !== latestDraw.expires_timestamp) {
              currentPatron = {
                name: latestDraw.patron_name,
                prayer: latestDraw.patron_prayer,
                expiresAt: latestDraw.expires_timestamp
              };
              displayPatron(currentPatron);
              startCountdown(currentPatron.expiresAt);
            }
          } else {
            if (hadActivePatron && now >= currentPatron.expiresAt) {
              currentPatron = null;
              resetDisplay();
            }
          }
        } else {
          if (hadActivePatron && now >= currentPatron.expiresAt) {
            currentPatron = null;
            resetDisplay();
          }
        }

        updateHistoryDisplay();
      }
    };

    function displayPatron(patron) {
      const patronContent = document.getElementById('patronContent');
      patronContent.innerHTML = `
        <div class="patron-name">${patron.name}</div>
        <div class="patron-prayer">${patron.prayer}</div>
      `;
      document.getElementById('drawButton').disabled = true;
      document.getElementById('countdownContainer').style.display = 'block';
    }

    function resetDisplay() {
      const patronContent = document.getElementById('patronContent');
      patronContent.innerHTML = '<p class="placeholder-text">Wylosuj swojego patrona na ten tydzie≈Ñ</p>';
      document.getElementById('drawButton').disabled = false;
      document.getElementById('countdownContainer').style.display = 'none';
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    function startCountdown(expiresAt) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      function updateCountdown() {
        const now = Date.now();
        const remaining = expiresAt - now;

        if (remaining <= 0) {
          clearInterval(countdownInterval);
          currentPatron = null;
          resetDisplay();
          return;
        }

        const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

        document.getElementById('countdownTimer').textContent = 
          `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }

      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    async function performDraw() {
      if (isAnimating) return;
      
      isAnimating = true;
      const patronDisplay = document.getElementById('patronDisplay');
      const patronContent = document.getElementById('patronContent');
      const drawButton = document.getElementById('drawButton');

      drawButton.disabled = true;
      
      patronDisplay.classList.add('slot-machine');

      let currentIndex = 0;
      let cycles = 0;
      const totalCycles = 40;
      
      const rollInterval = setInterval(() => {
        const saint = saints[currentIndex];
        patronContent.innerHTML = `
          <div class="patron-name">${saint.name}</div>
          <div class="patron-prayer">${saint.prayer}</div>
        `;

        currentIndex = (currentIndex + 1) % saints.length;
        cycles++;

        if (cycles >= totalCycles) {
          clearInterval(rollInterval);
          patronDisplay.classList.remove('slot-machine');
          finalizeDraw();
        }
      }, 80);
    }

    async function finalizeDraw() {
      const selectedSaint = saints[Math.floor(Math.random() * saints.length)];
      const now = Date.now();
      const expiresAt = now + (7 * 24 * 60 * 60 * 1000);

      const patronDisplay = document.getElementById('patronDisplay');
      const patronContent = document.getElementById('patronContent');

      patronDisplay.classList.add('final-reveal');
      patronContent.innerHTML = `
        <div class="patron-name">${selectedSaint.name}</div>
        <div class="patron-prayer">${selectedSaint.prayer}</div>
      `;

      setTimeout(() => {
        patronDisplay.classList.remove('final-reveal');
      }, 600);

      const result = await window.dataSdk.create({
        patron_name: selectedSaint.name,
        patron_prayer: selectedSaint.prayer,
        draw_timestamp: now,
        expires_timestamp: expiresAt,
        is_favorite: false
      });

      if (result.isOk) {
        currentPatron = {
          name: selectedSaint.name,
          prayer: selectedSaint.prayer,
          expiresAt: expiresAt
        };
        startCountdown(expiresAt);
        document.getElementById('countdownContainer').style.display = 'block';
      } else {
        patronContent.innerHTML = '<p class="placeholder-text">WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.</p>';
        document.getElementById('drawButton').disabled = false;
      }

      isAnimating = false;
    }

    function updateHistoryDisplay() {
      const historyList = document.getElementById('historyList');
      
      if (allPatrons.length === 0) {
        historyList.innerHTML = '<p class="no-history-text">Brak historii losowa≈Ñ</p>';
        return;
      }

      const sortedPatrons = [...allPatrons].sort((a, b) => b.draw_timestamp - a.draw_timestamp);
      
      const currentTheme = window.elementSdk?.config?.color_theme || defaultConfig.color_theme;
      const isSeasonal = window.elementSdk?.config?.is_seasonal || false;
      const theme = isSeasonal ? seasonalThemes[currentTheme] : colorThemes[currentTheme];
      const starColor = theme ? theme.accent : '#5a8dee';

      historyList.innerHTML = sortedPatrons.map(patron => {
        const date = new Date(patron.draw_timestamp);
        const dateStr = date.toLocaleDateString('pl-PL', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        const starIcon = patron.is_favorite ? '‚òÖ' : '‚òÜ';
        const starClass = patron.is_favorite ? 'star-button filled' : 'star-button';
        const starStyle = patron.is_favorite ? `style="color: ${starColor}"` : '';
        
        return `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-item-name">${patron.patron_name}</div>
              <div class="history-item-actions">
                <button class="${starClass}" data-id="${patron.__backendId}" ${starStyle}>${starIcon}</button>
                <button class="delete-button" data-id="${patron.__backendId}">
                  <svg class="delete-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="history-item-prayer">${patron.patron_prayer}</div>
            <div class="history-item-date">${dateStr}</div>
          </div>
        `;
      }).join('');

      attachHistoryEventListeners();
    }

    let patronToDelete = null;

    function attachHistoryEventListeners() {
      document.querySelectorAll('.star-button').forEach(button => {
        button.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          const patron = allPatrons.find(p => p.__backendId === id);
          if (patron) {
            e.currentTarget.classList.add('favorited');
            setTimeout(() => e.currentTarget.classList.remove('favorited'), 400);
            
            patron.is_favorite = !patron.is_favorite;
            
            if (patron.is_favorite) {
              e.currentTarget.textContent = '‚òÖ';
              e.currentTarget.classList.add('filled');
              const currentTheme = window.elementSdk?.config?.color_theme || defaultConfig.color_theme;
              const isSeasonal = window.elementSdk?.config?.is_seasonal || false;
              const theme = isSeasonal ? seasonalThemes[currentTheme] : colorThemes[currentTheme];
              if (theme) {
                e.currentTarget.style.color = theme.accent;
              }
            } else {
              e.currentTarget.textContent = '‚òÜ';
              e.currentTarget.classList.remove('filled');
              e.currentTarget.style.color = '';
            }
            
            const result = await window.dataSdk.update(patron);
            if (!result.isOk) {
              patron.is_favorite = !patron.is_favorite;
              if (patron.is_favorite) {
                e.currentTarget.textContent = '‚òÖ';
                e.currentTarget.classList.add('filled');
              } else {
                e.currentTarget.textContent = '‚òÜ';
                e.currentTarget.classList.remove('filled');
              }
            }
          }
        });
      });

      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const deleteBtn = e.currentTarget;
          const id = deleteBtn.dataset.id;
          const patron = allPatrons.find(p => p.__backendId === id);
          if (patron) {
            patronToDelete = patron;
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
          }
        });
      });
    }

    function applyColorTheme(themeKey, isSeasonalTheme = false) {
      const theme = isSeasonalTheme ? seasonalThemes[themeKey] : colorThemes[themeKey];
      if (!theme) return;

      document.body.style.background = `linear-gradient(180deg, ${theme.bg} 0%, ${theme.bgEnd} 100%)`;
      document.body.style.color = theme.text;

      const mainTitle = document.getElementById('mainTitle');
      if (mainTitle) {
        if (theme.isSeasonal) {
          mainTitle.style.color = '#ffffff';
          mainTitle.style.textShadow = '0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6)';
        } else {
          mainTitle.style.color = theme.text;
          mainTitle.style.textShadow = '2px 2px 4px rgba(6, 21, 52, 0.15)';
        }
      }

      const textElements = [
        document.querySelector('.countdown-label'),
        document.querySelector('.settings-title'),
        document.querySelector('.history-title'),
        document.querySelector('.confirm-delete-title'),
        document.querySelector('.settings-section-title')
      ];
      textElements.forEach(el => {
        if (el) {
          el.style.color = theme.text;
          el.style.textShadow = theme.textShadow || 'none';
        }
      });

      const historyItemNames = document.querySelectorAll('.history-item-name');
      historyItemNames.forEach(el => {
        el.style.color = theme.text;
        el.style.textShadow = theme.textShadow || 'none';
      });

      const colorThemeNames = document.querySelectorAll('.color-theme-name');
      colorThemeNames.forEach(el => {
        el.style.color = theme.text;
        el.style.textShadow = theme.textShadow || 'none';
      });

      const gradientElements = [
        document.getElementById('patronDisplay'),
        document.getElementById('drawButton')
      ];
      gradientElements.forEach(el => {
        if (el) el.style.background = `linear-gradient(135deg, ${theme.gradientStart} 0%, ${theme.gradientEnd} 100%)`;
      });

      const countdownTimer = document.getElementById('countdownTimer');
      if (countdownTimer) {
        countdownTimer.style.color = theme.accent;
        countdownTimer.style.textShadow = theme.textShadow || 'none';
      }

      const historyButton = document.getElementById('historyButton');
      if (historyButton) {
        historyButton.style.color = theme.gradientStart;
        historyButton.style.borderColor = theme.gradientStart;
      }

      const filledStars = document.querySelectorAll('.star-button.filled');
      filledStars.forEach(star => {
        star.style.color = theme.accent;
      });

      if (window.elementSdk && window.elementSdk.config) {
        window.elementSdk.setConfig({
          background_color: theme.bg,
          background_color_end: theme.bgEnd,
          primary_color: theme.gradientStart,
          primary_color_end: theme.gradientEnd,
          accent_color: theme.accent,
          navy_color: theme.text,
          color_theme: themeKey,
          is_seasonal: isSeasonalTheme
        });
      }
    }

    function renderColorThemes() {
      const grid = document.getElementById('colorThemesGrid');
      const currentTheme = (window.elementSdk && window.elementSdk.config) ? 
        window.elementSdk.config.color_theme || defaultConfig.color_theme : 
        defaultConfig.color_theme;
      const isCurrentSeasonal = (window.elementSdk && window.elementSdk.config) ? 
        window.elementSdk.config.is_seasonal || false : false;
      
      grid.innerHTML = Object.entries(colorThemes).map(([key, theme]) => {
        const isActive = key === currentTheme && !isCurrentSeasonal;
        return `
          <div class="color-theme-card ${isActive ? 'active' : ''}" data-theme="${key}">
            <div class="color-preview" style="background: ${theme.gradientStart}"></div>
            <div class="color-theme-name">${theme.name}</div>
          </div>
        `;
      }).join('');

      document.querySelectorAll('#colorThemesGrid .color-theme-card').forEach(card => {
        card.addEventListener('click', () => {
          const themeKey = card.dataset.theme;
          applyColorTheme(themeKey, false);
          
          document.querySelectorAll('.color-theme-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
        });
      });
    }

    function renderSeasonalThemes() {
      const grid = document.getElementById('seasonalThemesGrid');
      const currentTheme = (window.elementSdk && window.elementSdk.config) ? 
        window.elementSdk.config.color_theme || defaultConfig.color_theme : 
        defaultConfig.color_theme;
      const isCurrentSeasonal = (window.elementSdk && window.elementSdk.config) ? 
        window.elementSdk.config.is_seasonal || false : false;
      
      grid.innerHTML = Object.entries(seasonalThemes).map(([key, theme]) => {
        const isActive = key === currentTheme && isCurrentSeasonal;
        const subtitle = theme.subtitle ? `<div class="color-theme-subtitle">${theme.subtitle}</div>` : '';
        return `
          <div class="color-theme-card ${isActive ? 'active' : ''}" data-theme="${key}" data-seasonal="true">
            <div class="color-preview" style="background: ${theme.gradientStart}"></div>
            <div class="color-theme-name">${theme.name}</div>
            ${subtitle}
          </div>
        `;
      }).join('');

      document.querySelectorAll('#seasonalThemesGrid .color-theme-card').forEach(card => {
        card.addEventListener('click', () => {
          const themeKey = card.dataset.theme;
          applyColorTheme(themeKey, true);
          
          document.querySelectorAll('.color-theme-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
        });
      });
    }

    function renderAllHistoryInSettings() {
      const container = document.getElementById('allHistoryList');
      
      if (allPatrons.length === 0) {
        container.innerHTML = '<p class="no-history-text">Brak historii losowa≈Ñ</p>';
        return;
      }

      const sortedPatrons = [...allPatrons].sort((a, b) => b.draw_timestamp - a.draw_timestamp);
      
      const currentTheme = window.elementSdk?.config?.color_theme || defaultConfig.color_theme;
      const isSeasonal = window.elementSdk?.config?.is_seasonal || false;
      const theme = isSeasonal ? seasonalThemes[currentTheme] : colorThemes[currentTheme];
      const starColor = theme ? theme.accent : '#5a8dee';

      container.innerHTML = sortedPatrons.map(patron => {
        const date = new Date(patron.draw_timestamp);
        const dateStr = date.toLocaleDateString('pl-PL', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        const starIcon = patron.is_favorite ? '‚òÖ' : '‚òÜ';
        const starClass = patron.is_favorite ? 'star-button filled' : 'star-button';
        const starStyle = patron.is_favorite ? `style="color: ${starColor}"` : '';
        
        return `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-item-name">${patron.patron_name}</div>
              <div class="history-item-actions">
                <button class="${starClass}" data-id="${patron.__backendId}" ${starStyle}>${starIcon}</button>
                <button class="delete-button" data-id="${patron.__backendId}">
                  <svg class="delete-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="history-item-prayer">${patron.patron_prayer}</div>
            <div class="history-item-date">${dateStr}</div>
          </div>
        `;
      }).join('');

      attachHistoryEventListeners();
    }

    function renderFavoritesInSettings() {
      const container = document.getElementById('favoritesHistoryList');
      
      const favorites = allPatrons.filter(p => p.is_favorite);
      
      if (favorites.length === 0) {
        container.innerHTML = '<p class="no-history-text">Brak ulubionych patron√≥w</p>';
        return;
      }

      const sortedFavorites = [...favorites].sort((a, b) => b.draw_timestamp - a.draw_timestamp);
      
      const currentTheme = window.elementSdk?.config?.color_theme || defaultConfig.color_theme;
      const isSeasonal = window.elementSdk?.config?.is_seasonal || false;
      const theme = isSeasonal ? seasonalThemes[currentTheme] : colorThemes[currentTheme];
      const starColor = theme ? theme.accent : '#5a8dee';

      container.innerHTML = sortedFavorites.map(patron => {
        const date = new Date(patron.draw_timestamp);
        const dateStr = date.toLocaleDateString('pl-PL', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-item-name">${patron.patron_name}</div>
              <div class="history-item-actions">
                <button class="star-button filled" data-id="${patron.__backendId}" style="color: ${starColor}">‚òÖ</button>
                <button class="delete-button" data-id="${patron.__backendId}">
                  <svg class="delete-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="history-item-prayer">${patron.patron_prayer}</div>
            <div class="history-item-date">${dateStr}</div>
          </div>
        `;
      }).join('');

      attachHistoryEventListeners();
    }

    document.getElementById('settingsButton').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.remove('hidden');
      renderColorThemes();
      renderSeasonalThemes();
      
      setTimeout(() => {
        const settingsTabs = document.getElementById('settingsTabs');
        const settingsIndicator = document.getElementById('settingsTabIndicator');
        const activeSettingsTab = settingsTabs.querySelector('.settings-tab.active');
        if (settingsIndicator && activeSettingsTab) {
          updateTabIndicator(settingsTabs, settingsIndicator, activeSettingsTab);
        }
      }, 50);
    });

    function updateTabIndicator(tabsContainer, indicator, activeTab) {
      const tabs = Array.from(tabsContainer.querySelectorAll('.settings-tab'));
      const activeIndex = tabs.indexOf(activeTab);
      
      if (activeIndex !== -1) {
        const tabWidth = activeTab.offsetWidth;
        const tabLeft = activeTab.offsetLeft;
        
        indicator.style.width = `${tabWidth}px`;
        indicator.style.left = `${tabLeft}px`;
      }
    }

    document.querySelectorAll('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        const parentModal = tab.closest('.settings-modal, .history-modal');
        const tabsInModal = parentModal.querySelectorAll('.settings-tab');
        const contentsInModal = parentModal.querySelectorAll('.settings-tab-content');
        
        tabsInModal.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabsContainer = tab.closest('.settings-tabs');
        const indicator = tabsContainer.querySelector('.tab-indicator');
        if (indicator) {
          updateTabIndicator(tabsContainer, indicator, tab);
        }
        
        contentsInModal.forEach(content => content.classList.remove('active'));
        
        if (tabName === 'regular') {
          document.getElementById('regularTab').classList.add('active');
        } else if (tabName === 'seasonal') {
          document.getElementById('seasonalTab').classList.add('active');
        } else if (tabName === 'recent') {
          document.getElementById('recentTab').classList.add('active');
          updateHistoryDisplay();
        } else if (tabName === 'allhistory') {
          document.getElementById('allHistoryTab').classList.add('active');
          renderAllHistoryInSettings();
        } else if (tabName === 'favorites') {
          document.getElementById('favoritesTab').classList.add('active');
          renderFavoritesInSettings();
        }
      });
    });

    document.getElementById('closeSettingsButton').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.add('hidden');
    });

    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').classList.add('hidden');
      }
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
      document.getElementById('confirmDeleteModal').classList.add('hidden');
      patronToDelete = null;
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (patronToDelete) {
        const wasCurrentPatron = currentPatron && 
          patronToDelete.patron_name === currentPatron.name && 
          patronToDelete.expires_timestamp === currentPatron.expiresAt;
        
        const result = await window.dataSdk.delete(patronToDelete);
        if (!result.isOk) {
          console.error('B≈ÇƒÖd usuwania patrona');
        }
        document.getElementById('confirmDeleteModal').classList.add('hidden');
        patronToDelete = null;
      }
    });

    document.getElementById('confirmDeleteModal').addEventListener('click', (e) => {
      if (e.target.id === 'confirmDeleteModal') {
        document.getElementById('confirmDeleteModal').classList.add('hidden');
        patronToDelete = null;
      }
    });

    document.getElementById('historyButton').addEventListener('click', () => {
      document.getElementById('historyModal').classList.remove('hidden');
      updateHistoryDisplay();
      
      setTimeout(() => {
        const historyTabs = document.getElementById('historyTabs');
        const historyIndicator = document.getElementById('historyTabIndicator');
        const activeHistoryTab = historyTabs.querySelector('.settings-tab.active');
        if (historyIndicator && activeHistoryTab) {
          updateTabIndicator(historyTabs, historyIndicator, activeHistoryTab);
        }
      }, 50);
    });

    document.getElementById('closeHistoryButton').addEventListener('click', () => {
      document.getElementById('historyModal').classList.add('hidden');
    });

    document.getElementById('historyModal').addEventListener('click', (e) => {
      if (e.target.id === 'historyModal') {
        document.getElementById('historyModal').classList.add('hidden');
      }
    });

    document.getElementById('drawButton').addEventListener('click', (e) => {
      e.preventDefault();
      performDraw();
    });

    async function onConfigChange(config) {
      document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('drawButton').textContent = config.draw_button_text || defaultConfig.draw_button_text;
      document.getElementById('countdownLabel').textContent = config.time_remaining_label || defaultConfig.time_remaining_label;
      document.getElementById('historyButton').textContent = config.history_button_text || defaultConfig.history_button_text;

      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;

      document.getElementById('mainTitle').style.fontFamily = `Pacifico, ${baseFontStack}`;
      document.body.style.fontSize = `${baseSize}px`;
      
      const patronNames = document.querySelectorAll('.patron-name');
      const patronPrayers = document.querySelectorAll('.patron-prayer');
      const countdownTimers = document.querySelectorAll('.countdown-timer');
      
      patronNames.forEach(el => el.style.fontSize = `${baseSize * 1.75}px`);
      patronPrayers.forEach(el => el.style.fontSize = `${baseSize}px`);
      countdownTimers.forEach(el => el.style.fontSize = `${baseSize * 1.75}px`);

      const themeKey = config.color_theme || defaultConfig.color_theme;
      const isSeasonalTheme = config.is_seasonal || defaultConfig.is_seasonal;
      applyColorTheme(themeKey, isSeasonalTheme);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                window.elementSdk.config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                window.elementSdk.config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                window.elementSdk.config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            },
            {
              get: () => config.navy_color || defaultConfig.navy_color,
              set: (value) => {
                window.elementSdk.config.navy_color = value;
                window.elementSdk.setConfig({ navy_color: value });
              }
            },
            {
              get: () => config.modal_background || defaultConfig.modal_background,
              set: (value) => {
                window.elementSdk.config.modal_background = value;
                window.elementSdk.setConfig({ modal_background: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              window.elementSdk.config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              window.elementSdk.config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["main_title", config.main_title || defaultConfig.main_title],
          ["draw_button_text", config.draw_button_text || defaultConfig.draw_button_text],
          ["time_remaining_label", config.time_remaining_label || defaultConfig.time_remaining_label],
          ["history_button_text", config.history_button_text || defaultConfig.history_button_text]
        ])
      });
    }

    async function init() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error("Nie uda≈Ço siƒô zainicjowaƒá Data SDK");
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a8e0b961416bf36',t:'MTc2NDg4MDA1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

